
<!doctype html>
<html>
  <head>
    <title>Record Audio</title>
    <script src="lib/jquery.js"></script>
    <script src="lib/two.js"></script>
    <script src="Recorderjs-master/recorder.js"></script>
    <style type='text/css'>
      ul { list-style: none; }
      #recordingslist audio { display: block; margin-bottom: 10px; }
    </style>
  </head>
  <body>
    <div id="assets">
      <object type="image/svg+xml" data="SVGs/Dariusz-3.svg" id="avatar-svg" style="visibility:hidden; height:0"></object>
    </div>
    <div id="container" style="width:1440px">
      <div id="left-column" style="width:800px; float:left">
        <div id="two-container" align="right"></div>
      </div>
      <div id="right-column" style="width:640px; float:left">
        <video autoplay></video>
        <h2>Recorder.js simple WAV export example</h2>
        <button onclick="startRecordingAudio(this);">Record Audio</button>
        <button onclick="stopRecordingAudio(this);">Stop Audio Recording</button>
        <h3>Audio Recordings</h3>
        <ul id="audiorecordingslist"></ul>
        <h3>Log</h3>
        <pre id="log"></pre>
      </div>
    </div>
    
      <script>
      //Two.js stuff
        $(function(){

          var two_container = document.getElementById('two-container');
          var leftColumn = document.getElementById('left-column');
          var leftColumnWidth = $(leftColumn).width();
          var two = new Two({
            width: leftColumnWidth,
            height: $(window).height() - 25,
            autostart: true
          }).appendTo(two_container);
          var background = two.makeRectangle(two.width/2,two.height/2,two.width,two.height);

          var svgObject = document.getElementsByTagName('object')[0];
          svgObject.onload = function(){
              var mySvg = svgObject.contentDocument.getElementsByTagName('svg')[0];
              var shape = two.interpret(mySvg);
          };
          two.update();
        })
    

    //Getting user media
        function hasGetUserMedia(){
          return !!(navigator.hasGetUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);
        }

        if (hasGetUserMedia()){
          // Good to go

          var errorCallback = function(e){
            console.log('Rejected',e);
          };

          window.AudioContext = window.AudioContext || window.webkitAudioContext;

          navigator.getUserMedia  = navigator.getUserMedia ||
                          navigator.webkitGetUserMedia ||
                          navigator.mozGetUserMedia ||
                          navigator.msGetUserMedia;

          window.URL = window.URL || window.webkitURL;

          audio_context = new AudioContext;
          __log('Audio context set up.');
          __log('navigator.getUserMedia' + (navigator.getUserMedia ? 'available.' : 'not present!'));

          var video = document.querySelector('video');

          if (navigator.getUserMedia) {
            navigator.getUserMedia({audio: true, video: true}, /*startUserMedia,*/ function(stream) {
              //I added this?
              startUserMedia(stream);
              //
              video.src = window.URL.createObjectURL(stream);
            }, errorCallback);
          } else {
            video.src = 'somevideo.webm'; // fallback.
          }

        }else{
            alert('No web audio support in this browser');
        }



        //Recorder.js
        function __log(e,data){
          log.innerHTML += "\n" + e + " " + (data || '');
        }

        var audio_context;
        var recorder;

        //how do I incorporate this function?
        function startUserMedia(stream){
          var input = audio_context.createMediaStreamSource(stream);
          __log('Media stream created');
          input.connect(audio_context.destination);
          __log('Input connected to audio context destination.');
          recorder = new Recorder(input);
          __log('Recorder initialised.');
        }

        function startRecordingAudio(button){
          recorder && recorder.record();
          button.disabled = true;
          button.nextElementSibling.disabled = false;
          __log('Recording audio...');
        }        

        function stopRecordingAudio(button){
          recorder && recorder.stop();
          button.disabled = true;
          button.previousElementSibling.disabled = false;
          __log('Stopped recording audio.');

          createDownloadLink();

          recorder.clear();
        }

        function createDownloadLink() { //create WAV download link using audio data blob
          recorder && recorder.exportWAV(function(blob){
            var url = URL.createObjectURL(blob);
            var li = document.createElement('li');
            var au = document.createElement('audio');
            var hf = document.createElement('a');

            au.controls = true;
            au.src = url;
            hf.href = url;
            hf.download = new Date().toISOString() + '.wav';
            hf.innerHTML = hf.download;
            li.appendChild(au);
            li.appendChild(hf);
            audiorecordingslist.appendChild(li);

            console.log(audiorecordingslist);
          });
        }

      </script>
  </body>
</html>