<!doctype html>
<html>
  <head>
    <title>Live Video Feed</title>
    <script src="lib/jquery.js"></script>
    <script src="lib/two.js"></script>
    <script src="Recorderjs-master/recorder.js"></script>
    <style type='text/css'>
      ul { list-style: none; }
      #recordingslist audio { display: block; margin-bottom: 10px; }
    </style>
  </head>
  <body>
    <div id="assets">
      <object type="image/svg+xml" data="SVGs/Dariusz-3.svg" id="avatar-svg" style="visibility:hidden; height:0"></object>
    </div>
    <div id="container" style="width:1440px">
      <div id="left-column" style="width:800px; float:left">
        <div id="two-container" align="right"></div>
      </div>
      <div id="right-column" style="width:640px; float:left">
        <h3>Click on the video to take a frame capture</h3>
        <video autoplay></video>

        <img src="">
        <canvas style="display:none"></canvas>

        <h2>Recorder.js simple WAV export example</h2>
        <button onclick="startRecordingAudio(this);">Record Audio</button>
        <button onclick="stopRecordingAudio(this);">Stop Audio Recording</button>
        <h3>Messages from the server:</h3>
        <div id='chatlog'></div>
        <h3>Audio Recordings</h3>
        <ul id="audiorecordingslist"></ul>
      </div>
    </div>
    
      <script>
        $(function(){

          var two_container = document.getElementById('two-container');
          var leftColumn = document.getElementById('left-column');
          var leftColumnWidth = $(leftColumn).width();
          var two = new Two({
            width: leftColumnWidth,
            height: $(window).height() - 25,
            autostart: true
          }).appendTo(two_container);
          var background = two.makeRectangle(two.width/2,two.height/2,two.width,two.height);

          var svgObject = document.getElementsByTagName('object')[0];
          svgObject.onload = function(){
              var mySvg = svgObject.contentDocument.getElementsByTagName('svg')[0];
              var shape = two.interpret(mySvg);
          };
          two.update();
        })
    
        function hasGetUserMedia(){
          return !!(navigator.hasGetUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);
        }

        if (hasGetUserMedia()){
          var errorCallback = function(e){
            alert('Rejected');
          };

          window.AudioContext = window.AudioContext || window.webkitAudioContext;

          navigator.getUserMedia  = navigator.getUserMedia ||
                          navigator.webkitGetUserMedia ||
                          navigator.mozGetUserMedia ||
                          navigator.msGetUserMedia;

          window.URL = window.URL || window.webkitURL;

          audio_context = new AudioContext;

          var video = document.querySelector('video');

          var canvas = document.querySelector('canvas');
          var ctx = canvas.getContext('2d');
          var localMediaStream = null;

          var ws = new WebSocket('ws://127.0.0.1:1234','echo-protocol');
                
          function sendMessage(message){
                ws.send(message);
          }

          ws.addEventListener('message',function(e){
                //the data is simply the message that we're sending back
                var msg = e.data;
                  
                //Append the message
                document.getElementById('chatlog').innerHTML += '<br>' + msg;
          });

          function snapshot(){
            if(localMediaStream){
              ctx.drawImage(video,0,0);
              //"image/webp" works in Chrome
              //Other browsers will fall back to image/png.
              var frame = canvas.toDataURL('image/png');
              var image = document.querySelector('img');
              image.src = canvas.toDataURL('image/png');

              sendMessage(frame);
            }
          }

          video.addEventListener('click',snapshot,false);

          if (navigator.getUserMedia) {
            navigator.getUserMedia({audio: true, video: true}, function(stream) {
              startUserMedia(stream);
              video.src = window.URL.createObjectURL(stream);

              localMediaStream = stream;

            }, errorCallback);
          } else {
            video.src = 'somevideo.webm'; // fallback.
          }

        }else{
            alert('No web audio support in this browser');
        }




        var audio_context;
        var recorder;

        function startUserMedia(stream){
          var input = audio_context.createMediaStreamSource(stream);
          input.connect(audio_context.destination);
          recorder = new Recorder(input);
        }

        function startRecordingAudio(button){
          recorder && recorder.record();
          button.disabled = true;
          button.nextElementSibling.disabled = false;
        }        

        function stopRecordingAudio(button){
          recorder && recorder.stop();
          button.disabled = true;
          button.previousElementSibling.disabled = false;
          createDownloadLink();
          recorder.clear();
        }

        function createDownloadLink() { //create WAV download link using audio data blob
          recorder && recorder.exportWAV(function(blob){
            var url = URL.createObjectURL(blob);
            var li = document.createElement('li');
            var au = document.createElement('audio');
            var hf = document.createElement('a');

            au.controls = true;
            au.src = url;
            hf.href = url;
            hf.download = new Date().toISOString() + '.wav';
            hf.innerHTML = hf.download;
            li.appendChild(au);
            li.appendChild(hf);
            audiorecordingslist.appendChild(li);
          });
        }

      </script>
  </body>
</html>