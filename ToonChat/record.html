
<!doctype html>
<html>
  <head>
    <title>Record Movement & Stress Test</title>
    <script src="lib/jquery.js"></script>
    <script src="lib/two.js"></script>
    <script type="text/javascript">
        function noenter() {
        return !(window.event && window.event.keyCode == 13); }
    </script>
    <style>
      .assets { display: none; }
    </style>
  </head>
  <body>
    <div class="assets">
    </div>
    <div id="container" style="width:1440px">
      <div id="left-column" style="width:200px; float:left">
        <h1 id="currentMode">Recording</h1>
        <p id="description">Demo to test how many points two.js can easily keep track of, as well as how effective the current method of saving data is.</p>
        <h2 id="time">0</h2>
        <button type="button" id="switch-mode">Play</button>
        <button type="button" id="record-button">Record</button>
        <form id="number-of-shapes" action="">
            Number of shapes:<input type="text" name="number_of_shapes" id="numOfShapes" onkeypress="return noenter()" value="100" style="width:100px">
            <button type="button" id="update-numOfShapes-button" align="right">OK</button>
        </form>
        <h3 id="frame-rate">FPS</h3>
      </div>
      <div id="right-column" style="width:1140px; float:left">
        <div id="two-container" align="right"></div>
      </div>
    </div>
    <div class="scripts">
      <script>

        $(function() {

          sessionStorage.clear();

          var two_container = document.getElementById('two-container');
          var leftColumn = document.getElementById('left-column');
          var leftColumnWidth = $(leftColumn).width();
          var two = new Two({
            width: $(window).width() - leftColumnWidth - 25,
            height: $(window).height() - 25,
            autostart: true
          }).appendTo(two_container);
          var background;
          var x, y, line, mouse = new Two.Vector();

          var isRecording = false;
          var currentMode = document.getElementById("currentMode");
          var timeText = document.getElementById("time");
          var timeElapsed;
          var $window = $(window);

          var redDotRadius = 25;
          var recordIndicator = two.makeCircle(two.width - 4*redDotRadius, redDotRadius*2 , redDotRadius);
          recordIndicator.noStroke();

          //elements that need to have their position recorded
          var elementsToRecord = [];

          var numberOfShapes = 100;

          var framrate = document.getElementById('frame-rate');

          var fps = {
            startTime : 0,
            frameNumber : 0,
            getFPS : function(){
              this.frameNumber++;
              var d = new Date().getTime(),
                currentTime = ( d - this.startTime ) / 1000,
                result = Math.floor( ( this.frameNumber / currentTime ) );

              if( currentTime > 1 ){
                this.startTime = new Date().getTime();
                this.frameNumber = 0;
              }
              return result;

            } 
          };

          function makeShapes(number){ // create random shapes
            background = two.makeRectangle(two.width/2,two.height/2,two.width,two.height);
            elementsToRecord = [];
            for(var i=0; i<number; i++){
              var radius = 50 * Math.random();
              var x = two.width * Math.random();
              var y = two.height * Math.random();
              var circle = two.makeCircle(x,y,radius);
              circle.noStroke();
              circle.fill = getRandomColor();
              assignRandomMovement(circle);
              elementsToRecord.push(circle);
            }
          }
          makeShapes(numberOfShapes);
          
          two.update();

            two.bind('update', function () {
              framrate.innerHTML = "Frame Rate: "+fps.getFPS()+" fps";
              recordIndicator.fill ="white";
              if(currentMode.innerHTML == "Recording"){
                moveShapes();
                if(isRecording){
                  recordIndicator.fill="red";
                  timeElapsed++;              
                  timeText.innerHTML = timeElapsed;
                  recordPoints();
                }
              }else{
                timeElapsed++;
                if(sessionStorage.getItem(timeElapsed)!=null){
                  timeText.innerHTML = timeElapsed;
                  playbackPoints();
                }
              }
          });
               
            document.getElementById("record-button").onclick= function(){
              if(!isRecording && currentMode.innerHTML == "Recording"){
                  sessionStorage.clear();
                  timeElapsed = 0;
                  isRecording = true;
                  document.getElementById("record-button").innerHTML = "Stop";
                  document.getElementById("switch-mode").style.visibility = "hidden";
                  document.getElementById("number-of-shapes").style.visibility = "hidden";
                }else{
                  isRecording = false;
                  document.getElementById("record-button").innerHTML = "Record";
                  document.getElementById("switch-mode").style.visibility = "visible";
                  document.getElementById("number-of-shapes").style.visibility = "visible";
                }
            };

            document.getElementById("switch-mode").onclick = function(){
                if(currentMode.innerHTML == "Recording" && !isRecording){
                  isRecording = false;
                  timeElapsed = 0;
                  currentMode.innerHTML = "Playing";
                  document.getElementById("switch-mode").innerHTML = "Back to Record"
                  document.getElementById("record-button").style.visibility = "hidden";
                  document.getElementById("number-of-shapes").style.visibility = "hidden";
                }else if(currentMode.innerHTML == "Playing" && !isRecording){
                  two.clear();
                  makeShapes(numberOfShapes);
                  timeText.innerHTML = 0;
                  currentMode.innerHTML = "Recording";
                  document.getElementById("switch-mode").innerHTML = "Play"
                  document.getElementById("record-button").style.visibility = "visible";
                  document.getElementById("number-of-shapes").style.visibility = "visible";
                }
            }

            document.getElementById('update-numOfShapes-button').onclick= function(){ // updates the number of shapes
              if(currentMode.innerHTML == "Recording" && !isRecording){
                    numberOfShapes = document.getElementById('numOfShapes').value;
                    two.clear();
                    makeShapes(numberOfShapes);
              }
            }

          function recordPoints(){ // save all the important points
              var saveData = "";
              for(var i=0; i<elementsToRecord.length;i++){
                  if(i==elementsToRecord.length-1){
                    saveData = saveData + elementsToRecord[i].translation;
                  }else{
                    saveData = saveData + elementsToRecord[i].translation + '|';
                  }
              }
              sessionStorage.setItem(timeElapsed,saveData);
          }

          function playbackPoints(){ // get all the save points at the appropriate time
                var points = sessionStorage.getItem(timeElapsed).split('|');
                for(var i=0; i<points.length; i++){
                    var coordinates = points[i].split(',');
                    elementsToRecord[i].translation.set(coordinates[0],coordinates[1]);
                }
          }

          function assignRandomMovement(shape){
              shape.horzMovement = 10 * Math.random() - 5;
              shape.vertMovement = 10 * Math.random() - 5;
          }

          function moveShapes(){
            for(var i=0;i<elementsToRecord.length;i++){
              elementsToRecord[i].translation.x += elementsToRecord[i].horzMovement;
              elementsToRecord[i].translation.y += elementsToRecord[i].vertMovement;
              if(elementsToRecord[i].translation.x < 0 || elementsToRecord[i].translation.x > two.width){
                elementsToRecord[i].horzMovement = -elementsToRecord[i].horzMovement;
              }
              if(elementsToRecord[i].translation.y < 0 || elementsToRecord[i].translation.y > two.height){
                elementsToRecord[i].vertMovement = -elementsToRecord[i].vertMovement;
              }
            }
          }

          function getRandomColor() {
                     return 'rgba('
                           + Math.floor(Math.random() * 255) + ','
                           + Math.floor(Math.random() * 255) + ','
                           + Math.floor(Math.random() * 255) + ','
                           + 1 + ')';
          }

        });


      </script>
    </div>
  </body>
</html>